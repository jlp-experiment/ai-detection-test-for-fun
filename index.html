<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI vs Human Fiction Detection Test (Extended Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- No Firebase - results displayed locally only -->
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const FictionDetectionTest = () => {
          const [stage, setStage] = useState('welcome');
          const [allSamples, setAllSamples] = useState([]);
          const [testSamples, setTestSamples] = useState([]);
          const [currentSampleIndex, setCurrentSampleIndex] = useState(0);
          const [responses, setResponses] = useState([]);
          const [currentResponse, setCurrentResponse] = useState({
            sampleId: null,
            guess: null,
            certainty: null
          });
          const [favoriteId, setFavoriteId] = useState(null);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [showDetailedResults, setShowDetailedResults] = useState(true);
          const textContainerRef = React.useRef(null);

          useEffect(() => {
            const loadSamples = async () => {
              setLoading(true);
              try {
                const response = await fetch('samples.json');
                if (!response.ok) throw new Error('Failed to load samples');
                const data = await response.json();
                setAllSamples(data);
                
                // Select 6 samples with no family duplicates
                const selectedSamples = selectSamplesNoFamilyDuplicates(data, 6);
                setTestSamples(selectedSamples);
                
                setLoading(false);
              } catch (err) {
                setError('Failed to load samples. Please refresh the page.');
                setLoading(false);
              }
            };

            if (stage === 'testing') {
              loadSamples();
            }
          }, [stage]);

          const selectSamplesNoFamilyDuplicates = (samples, count) => {
            const shuffled = [...samples].sort(() => Math.random() - 0.5);
            const selected = [];
            const usedFamilies = new Set();
            
            for (const sample of shuffled) {
              if (selected.length >= count) break;
              if (!usedFamilies.has(sample.familyId)) {
                selected.push(sample);
                usedFamilies.add(sample.familyId);
              }
            }
            
            return selected;
          };

          const formatText = (text) => {
            // Convert *text* to <em>text</em> for italics
            return text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
          };

          const handleGuessChange = (guess) => {
            setCurrentResponse(prev => ({
              ...prev,
              sampleId: testSamples[currentSampleIndex].id,
              guess
            }));
          };

          const handleCertaintyChange = (certainty) => {
            setCurrentResponse(prev => ({
              ...prev,
              certainty
            }));
          };

          const handleTestingNext = () => {
            setResponses(prev => [...prev, currentResponse]);
            
            if (currentSampleIndex < testSamples.length - 1) {
              setCurrentSampleIndex(prev => prev + 1);
              setCurrentResponse({
                sampleId: testSamples[currentSampleIndex + 1].id,
                guess: null,
                certainty: null
              });
            } else {
              setStage('favorite');
            }
            // Scroll to top after state updates
            setTimeout(() => {
              window.scrollTo(0, 0);
              if (textContainerRef.current) {
                textContainerRef.current.scrollTop = 0;
              }
            }, 0);
          };

          const handleFavoriteSelect = () => {
            setStage('results');
          };

          const canSubmitResponse = currentResponse.guess && currentResponse.certainty;

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="text-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                  <p className="text-gray-600">Loading samples...</p>
                </div>
              </div>
            );
          }

          if (error) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 max-w-md text-center">
                  <div className="text-4xl mb-4">‚ö†Ô∏è</div>
                  <h2 className="text-xl font-bold text-gray-900 mb-2">Error</h2>
                  <p className="text-gray-600">{error}</p>
                </div>
              </div>
            );
          }

          if (stage === 'welcome') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                <div className="max-w-3xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">
                  <div className="flex items-center gap-3 mb-6">
                    <span className="text-4xl">üìö</span>
                    <h1 className="text-3xl font-bold text-gray-900">AI vs. Human Fiction Test</h1>
                  </div>
                  
                  <div className="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-4">
                    <p className="text-yellow-900 font-semibold mb-2">‚ö†Ô∏è Please Take the Real Version First!</p>
                    <p className="text-yellow-800 text-sm">
                      For science! Please take the <a href="https://jlp-experiment.github.io/ai-detection-test/" target="_blank" rel="noopener noreferrer" className="underline font-medium hover:text-yellow-900">official research version</a> first before trying this extended version. The research version contributes to actual data collection about AI detection.
                    </p>
                  </div>
                  
                  <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6">
                    <p className="text-indigo-900 font-medium">
                      Extended Version: 6 Samples
                    </p>
                  </div>
                  
                  <div className="prose prose-lg mb-8">
                    <p className="text-gray-700">
                      Welcome! This test explores whether readers can distinguish between AI-generated 
                      and human-written fiction openings.
                    </p>
                    
                    <h2 className="text-xl font-semibold text-gray-900 mt-6 mb-3">How it works:</h2>
                    <ol className="text-gray-700 space-y-2">
                      <li>Read 6 novel opening chapters (600-1500 words each).</li>
                      <li>For each sample, guess whether it was written by AI or a human. (NOTE: It's possible that the selection you see might be all AI samples or all human samples.)</li>
                      <li>Rate your certainty from 1 (least certain) to 5 (most certain).</li>
                      <li>After you read all the samples, select which one you enjoyed most.</li>
                      <li>See the results and which samples were actually AI-generated and which were human-written.</li>
                    </ol>
                  </div>

                  <button
                    onClick={() => setStage('testing')}
                    className="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-md text-white font-medium bg-indigo-600 hover:bg-indigo-700"
                  >
                    Begin Test
                    <span>‚Üí</span>
                  </button>
                </div>
              </div>
            );
          }

          if (stage === 'testing' && testSamples.length > 0) {
            const currentSample = testSamples[currentSampleIndex];
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">
                  <div className="mb-6">
                    <h2 className="text-2xl font-bold text-gray-900">
                      Sample {currentSampleIndex + 1} of {testSamples.length}
                    </h2>
                  </div>

                  <div ref={textContainerRef} className="prose prose-lg max-w-none mb-8 p-6 bg-gray-50 rounded-lg max-h-96 overflow-y-auto">
                    {currentSample.text.split('\n').map((paragraph, idx) => (
                      <p key={idx} className="mb-4 text-gray-800 whitespace-pre-wrap"
                         dangerouslySetInnerHTML={{ __html: formatText(paragraph) }}>
                      </p>
                    ))}
                  </div>

                  <div className="border-t pt-6 space-y-6">
                    <div>
                      <label className="block text-lg font-semibold text-gray-900 mb-3">
                        Was this written by AI or a human?
                      </label>
                      <div className="flex gap-4">
                        <button
                          onClick={() => handleGuessChange('AI')}
                          className={`flex-1 py-3 px-6 rounded-md font-medium transition-all ${
                            currentResponse.guess === 'AI'
                              ? 'bg-indigo-600 text-white shadow-lg'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          AI Generated
                        </button>
                        <button
                          onClick={() => handleGuessChange('Human')}
                          className={`flex-1 py-3 px-6 rounded-md font-medium transition-all ${
                            currentResponse.guess === 'Human'
                              ? 'bg-indigo-600 text-white shadow-lg'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          Human Written
                        </button>
                      </div>
                    </div>

                    <div>
                      <label className="block text-lg font-semibold text-gray-900 mb-3">
                        How certain are you? (1 = least certain, 5 = most certain)
                      </label>
                      <div className="flex gap-2">
                        {[1, 2, 3, 4, 5].map((level) => (
                          <button
                            key={level}
                            onClick={() => handleCertaintyChange(level)}
                            className={`flex-1 py-3 px-4 rounded-md font-medium transition-all ${
                              currentResponse.certainty === level
                                ? 'bg-indigo-600 text-white shadow-lg'
                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                          >
                            {level}
                          </button>
                        ))}
                      </div>
                    </div>

                    <button
                      onClick={handleTestingNext}
                      disabled={!canSubmitResponse}
                      className={`w-full flex items-center justify-center gap-2 px-6 py-3 rounded-md text-white font-medium ${
                        canSubmitResponse
                          ? 'bg-indigo-600 hover:bg-indigo-700'
                          : 'bg-gray-300 cursor-not-allowed'
                      }`}
                    >
                      {currentSampleIndex < testSamples.length - 1 ? 'Next Sample' : 'Continue to Final Question'}
                      <span>‚Üí</span>
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          if (stage === 'favorite') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                <div className="max-w-3xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">
                  <h2 className="text-2xl font-bold text-gray-900 mb-6">
                    Which sample did you enjoy the most?
                  </h2>
                  
                  <div className="space-y-3 mb-6">
                    {testSamples.map((sample, idx) => (
                      <button
                        key={sample.id}
                        onClick={() => setFavoriteId(sample.id)}
                        className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                          favoriteId === sample.id
                            ? 'border-indigo-600 bg-indigo-50'
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          <div className={`mt-1 w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                            favoriteId === sample.id ? 'border-indigo-600 bg-indigo-600' : 'border-gray-300'
                          }`}>
                            {favoriteId === sample.id && <span className="text-white text-xs">‚úì</span>}
                          </div>
                          <div>
                            <div className="font-medium text-gray-900 mb-1">Sample {idx + 1}</div>
                            <div className="text-sm text-gray-600">{sample.description}</div>
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>

                  <button
                    onClick={handleFavoriteSelect}
                    disabled={!favoriteId}
                    className={`w-full flex items-center justify-center gap-2 px-6 py-3 rounded-md text-white font-medium ${
                      favoriteId
                        ? 'bg-indigo-600 hover:bg-indigo-700'
                        : 'bg-gray-300 cursor-not-allowed'
                    }`}
                  >
                    See Results
                    <span>‚Üí</span>
                  </button>
                </div>
              </div>
            );
          }

          if (stage === 'results') {
            const correctCount = responses.filter((r) => {
              const sample = testSamples.find(s => s.id === r.sampleId);
              return sample && ((r.guess === 'AI' && sample.isAI) || (r.guess === 'Human' && !sample.isAI));
            }).length;

            const favoriteSample = testSamples.find(s => s.id === favoriteId);

            // Score-only view (safe to share)
            if (!showDetailedResults) {
              return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                  <div className="max-w-3xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">
                    <h2 className="text-3xl font-bold text-gray-900 mb-2">Your Score</h2>
                    <p className="text-xl text-gray-700 mb-8">
                      You correctly identified {correctCount} out of {testSamples.length} samples
                      ({Math.round((correctCount / testSamples.length) * 100)}% accuracy)
                    </p>

                    {favoriteSample && (
                      <div className="p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-6">
                        <h3 className="font-semibold text-gray-900 mb-2">Your Favorite Sample:</h3>
                        <p className="text-gray-700">
                          Your favorite was Sample {testSamples.findIndex(s => s.id === favoriteId) + 1}.
                        </p>
                      </div>
                    )}

                    <button
                      onClick={() => setShowDetailedResults(true)}
                      className="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-md text-white font-medium bg-indigo-600 hover:bg-indigo-700 mb-4"
                    >
                      View Detailed Results
                      <span>‚Üí</span>
                    </button>
                    
                    <div className="text-center text-sm text-gray-500">
                      Thank you for taking the extended version!
                    </div>
                  </div>
                </div>
              );
            }

            // Detailed results view (with spoiler warning)
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                <div className="max-w-3xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">
                  <div className="bg-red-50 border-2 border-red-400 rounded-lg p-4 mb-6">
                    <p className="text-red-900 font-semibold mb-2">‚ö†Ô∏è Spoiler Warning - Please Don't Share!</p>
                    <p className="text-red-800 text-sm mb-3">
                      This page reveals which samples are AI vs. human. Please don't screenshot or share these details, as it would spoil the test for others who haven't taken the real research version yet.
                    </p>
                    <button
                      onClick={() => setShowDetailedResults(false)}
                      className="text-sm px-4 py-2 bg-red-100 hover:bg-red-200 text-red-900 rounded-md font-medium"
                    >
                      Hide Detailed Results (Show Score Only)
                    </button>
                  </div>

                  <h2 className="text-3xl font-bold text-gray-900 mb-2">Detailed Results</h2>
                  <p className="text-xl text-gray-700 mb-8">
                    You correctly identified {correctCount} out of {testSamples.length} samples
                    ({Math.round((correctCount / testSamples.length) * 100)}% accuracy)
                  </p>

                  <div className="space-y-4 mb-8">
                    {testSamples.map((sample, idx) => {
                      const response = responses.find(r => r.sampleId === sample.id);
                      const isCorrect = response && (
                        (response.guess === 'AI' && sample.isAI) || 
                        (response.guess === 'Human' && !sample.isAI)
                      );

                      return (
                        <div
                          key={sample.id}
                          className={`p-4 rounded-lg border-2 ${
                            isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'
                          }`}
                        >
                          <div className="flex items-start justify-between mb-2">
                            <div className="font-semibold text-gray-900">Sample {idx + 1}</div>
                            <div className={`px-3 py-1 rounded text-sm font-medium ${
                              isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
                            }`}>
                              {isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                            </div>
                          </div>
                          <div className="text-sm text-gray-700 mb-2">{sample.description}</div>
                          <div className="flex gap-4 text-sm">
                            <div>
                              <span className="font-medium">Actually:</span>{' '}
                              <span className={sample.isAI ? 'text-purple-700' : 'text-blue-700'}>
                                {sample.isAI ? 'AI Generated' : 'Human Written'}
                              </span>
                            </div>
                            <div>
                              <span className="font-medium">Your guess:</span> {response?.guess}
                            </div>
                            <div>
                              <span className="font-medium">Certainty:</span> {response?.certainty}/5
                            </div>
                          </div>
                          {sample.id === favoriteId && (
                            <div className="mt-2 text-sm font-medium text-indigo-600">
                              ‚≠ê Your favorite
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>

                  {favoriteSample && (
                    <div className="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                      <h3 className="font-semibold text-gray-900 mb-2">Your Favorite Sample:</h3>
                      <p className="text-gray-700">
                        You enjoyed the {favoriteSample.isAI ? 'AI-generated' : 'human-written'} sample most:{' '}
                        <span className="italic">{favoriteSample.description}</span>
                      </p>
                    </div>
                  )}
                  
                  <div className="mt-6 text-center text-sm text-gray-500">
                    Thank you for taking the extended version!
                  </div>
                </div>
              </div>
            );
          }

          return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(FictionDetectionTest));
    </script>
</body>
</html>
